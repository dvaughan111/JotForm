<!DOCTYPE html>
<html>
<head>
    <script src="//js.jotform.com/JotformCustomWidget.min.js"></script>
    <style>
        body {
            font-family: Helvetica, Arial, sans-serif; /* Changed to Helvetica with Arial as fallback */
            padding: 10px;
            margin: 0;
            overflow: hidden; /* Prevent body scrollbars */
        }

        .field-group {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            position: relative; /* For positioning the remove button */
            padding-bottom: 25px; /* Give space for the remove button */
        }

        .label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .date-field,
        .text-field {
            display: block;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Ensures padding is included in width */
            font-size: 14px;
            line-height: 1.5;
        }

        .date-field {
            width: calc(100% - 22px); /* Adjust width to fit icon/padding if date picker is there */
            max-width: 180px; /* Constrain date field width */
        }

        .text-field {
            width: 100%; /* Make it fill its container */
            /* This is the defensive design change: set max-width to accommodate Jotform's iframe constraints */
            max-width: 370px; /* ADJUST THIS VALUE if needed. Based on observed Jotform container widths like 380px or 290px */
            min-height: 100px; /* For textarea */
            resize: vertical; /* Allows user to resize vertically */
            overflow: auto; /* Adds scrollbar if content overflows vertically */
        }

        .add-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            display: block; /* Make it a block element to take full width if desired */
            width: fit-content; /* Adjust to content width */
        }

        .add-button:hover {
            background-color: #45a049;
        }

        .remove-button {
            background-color: #f44336;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            position: absolute; /* Position relative to .field-group */
            bottom: 5px;
            left: 15px; /* Adjust as needed */
        }

        .remove-button:hover {
            background-color: #da190b;
        }
    </style>
</head>
<body>
    <button type="button" class="add-button">Add Date + Text Field</button>
    <div id="fields-container">
        </div>

    <script>
        let fieldCounter = 0;
        const fieldsContainer = document.getElementById('fields-container');
        const addButton = document.querySelector('.add-button');

        function createFieldGroup(dateValue = '', textValue = '') {
            fieldCounter++;
            const fieldGroup = document.createElement('div');
            fieldGroup.className = 'field-group';
            fieldGroup.dataset.id = fieldCounter; // Assign a unique ID to the group

            fieldGroup.innerHTML = `
                <label for="date_${fieldCounter}" class="label">Date ${fieldCounter}:</label>
                <input type="date" id="date_${fieldCounter}" class="date-field" value="${dateValue}">

                <label for="text_${fieldCounter}" class="label">Text ${fieldCounter}:</label>
                <textarea id="text_${fieldCounter}" class="text-field">${textValue}</textarea>

                <button type="button" class="remove-button">Remove</button>
            `;

            const removeButton = fieldGroup.querySelector('.remove-button');
            removeButton.onclick = function() {
                fieldGroup.remove();
                updateWidgetValue(); // Update data after removing a field group
                requestResize();
            };

            const dateField = fieldGroup.querySelector('.date-field');
            dateField.onchange = updateWidgetValue;

            const textField = fieldGroup.querySelector('.text-field');
            textField.oninput = function() { // Use oninput for textareas
                updateWidgetValue();
                requestResize(); // Request resize on every input to adjust for growing text
            };

            fieldsContainer.appendChild(fieldGroup);
            requestResize(); // Request resize after adding a new field group
        }

        function updateWidgetValue() {
            const data = {};
            document.querySelectorAll('.field-group').forEach(group => {
                const id = group.dataset.id;
                const dateField = group.querySelector('.date-field');
                const textField = group.querySelector('.text-field');
                data[`date_${id}`] = dateField ? dateField.value : '';
                data[`text_${id}`] = textField ? textField.value : '';
            });
            JFCustomWidget.setValue(data);
        }

        function requestResize() {
            const body = document.body;
            // Get the scrollHeight of the body to include all content
            const height = body.scrollHeight;
            JFCustomWidget.requestFrameResize({ height: height + 60 }); // Increased padding
        }

        // Initialize with one field group on load
        createFieldGroup();
        updateWidgetValue(); // Set initial empty value

        addButton.onclick = function() {
            createFieldGroup();
            updateWidgetValue(); // Update data after adding a new field group
        };

        // Handle initial widget value if loaded from Jotform
        JFCustomWidget.getValue(function(value) {
            if (value && Object.keys(value).length > 0) {
                // Clear existing initial field
                fieldsContainer.innerHTML = '';
                // Populate fields from saved value
                const keys = Object.keys(value).sort((a, b) => {
                    const idA = parseInt(a.split('_')[1]);
                    const idB = parseInt(b.split('_')[1]);
                    return idA - idB;
                });

                const fieldGroupData = {};
                keys.forEach(key => {
                    const [type, id] = key.split('_');
                    if (!fieldGroupData[id]) {
                        fieldGroupData[id] = {};
                    }
                    fieldGroupData[id][type] = value[key];
                });

                Object.values(fieldGroupData).forEach(data => {
                    createFieldGroup(data.date, data.text);
                });
                updateWidgetValue(); // Update data after populating
            }
        });
    </script>
</body>
</html>
