<!DOCTYPE html>
<html>
<head>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            margin: 0;
        }
        
        .add-button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .field-group {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            background: #f9f9f9;
        }
        
        .date-field {
            width: 120px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin: 5px 0;
        }
        
        .text-field {
            width: 400px;
            max-width: 100%;
            min-height: 120px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            resize: none;
            overflow: hidden;
            line-height: 1.4;
            box-sizing: border-box;
        }
        
        .remove-button {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .field-label {
            font-weight: bold;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <button class="add-button" onclick="addDateTextField()">Add Date + Text Field</button>
    <div id="container"></div>
    
    <script>
        let counter = 0;
        let widgetData = {};
        
        // Always subscribe to ready event - this is required by JotForm
        JFCustomWidget.subscribe("ready", function(data) {
            // Load existing data if editing a submission
            if (data && data.value) {
                try {
                    widgetData = JSON.parse(data.value);
                    // Restore existing fields here if needed
                } catch(e) {
                    widgetData = {};
                }
            }
        });
        
        // Subscribe to submit event - required for form submission
        JFCustomWidget.subscribe("submit", function() {
            var result = {
                valid: true, // Always set to true since this widget doesn't have required validation
                value: JSON.stringify(widgetData)
            };
            JFCustomWidget.sendSubmit(result);
        });
        
        function addDateTextField() {
            counter++;
            
            var container = document.getElementById('container');
            var fieldGroup = document.createElement('div');
            fieldGroup.className = 'field-group';
            fieldGroup.id = 'group-' + counter;
            
            fieldGroup.innerHTML = `
                <div class="field-label">Date ${counter}:</div>
                <input type="date" class="date-field" name="date_${counter}" onchange="updateData()">
                <div class="field-label">Text ${counter}:</div>
                <textarea class="text-field" name="text_${counter}" placeholder="Enter text here..." oninput="autoResize(this); updateData();" onchange="updateData()"></textarea>
                <button class="remove-button" onclick="removeGroup('group-${counter}')">Remove</button>
            `;
            
            container.appendChild(fieldGroup);
            updateData();
            
            // Request frame resize to accommodate new content
            requestResize();
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            const lineHeight = 20;
            const baseLines = 8;
            const currentLines = Math.ceil(textarea.scrollHeight / lineHeight);
            
            if (currentLines > baseLines) {
                const additionalLines = Math.ceil((currentLines - baseLines) / 2) * 2;
                const newHeight = (baseLines + additionalLines) * lineHeight;
                textarea.style.height = newHeight + 'px';
            } else {
                textarea.style.height = (baseLines * lineHeight) + 'px';
            }
            
            // Request frame resize when text area expands
            requestResize();
        }
        
        function removeGroup(groupId) {
            document.getElementById(groupId).remove();
            updateData();
            requestResize();
        }
        
        function updateData() {
            const data = {};
            const dateFields = document.querySelectorAll('.date-field');
            const textFields = document.querySelectorAll('.text-field');
            
            dateFields.forEach(field => {
                if (field.value) {
                    data[field.name] = field.value;
                }
            });
            
            textFields.forEach(field => {
                if (field.value) {
                    data[field.name] = field.value;
                }
            });
            
            widgetData = data;
            
            // Send data to JotForm using sendData method
            JFCustomWidget.sendData({
                value: JSON.stringify(widgetData)
            });
        }
        
        function requestResize() {
            // Calculate total height needed
            const body = document.body;
            const html = document.documentElement;
            const height = Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);
            
            // Request frame resize
            JFCustomWidget.requestFrameResize({
                height: height + 20 // Add some padding
            });
        }
    </script>
</body>
</html>